---
title: "Thalictrum Scent:  Phylogenetic Signal"
author: Jesus Martinez-Gomez
date: May 11 2018
output:
  pdf_document: default
    toc: true

---
The following script accompanies the manscript 'Scent Matters: Repeated loss of insect attraction by floral scent accompanies transition to wind Pollination.'

Test for phylogenetic signal by Bloombergs K under Brownian motion are tested with the Thalictrum Floral Scent data and the Phylogeny. test for phylogenetic signal under Browninan motion in Thalictrum flora scent data. 

#Set Working Directory
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '~/Desktop/Thalictrum-Floral-Scent-master/PhylogeneticSignal')
knitr::opts_chunk$set(echo=TRUE, warning = FALSE, message = FALSE)
```

##Load libraries and data
``` {r Library and Import data }
#Load Libraries
library(phytools)
library(adephylo)
library(picante) 
library(phylocurve)
library(geomorph)

#Import Data
scent <- read.csv("data.csv")
 #Scent dataframe
tree <-read.nexus('THALICTRUM86.tre') 
 #Read in pre-cooked Maximum A Posterior Phylogeny (MAP)
```

# Data Wrangle

## Prune Tree down to 11 Species in Study
```{r Trim_Tree}
keepSpecies <- unique(as.character(scent$Species_Name_Full))
trimedTree<-drop.tip(tree,tree$tip.label[-match(keepSpecies, tree$tip.label)])
plot(trimedTree) # Plot trimmed tree
```

## Extract Relvant Information from Scent Dataframe
1) Extract scent emission data
2) Average across taxa
3) Formate for Phylogenetic Signal functions
```{r Prune_Data, results="hide"}
#1) 
scentCompounds <- scent[,9:63] # extract only scent data including mass*time column
scentCompounds$Species_Name_Full <- scent$Species_Name_Full 

#2)  Average Scent Data across 
avgScentCompounds <- aggregate( scentCompounds, 
                                by=list(scentCompounds$Species_Name_Full),
                                FUN = mean,
                                na.rm=TRUE)
#3)       
avgScentCompounds$Species_Name_Full <- NULL
row.names(avgScentCompounds) <- avgScentCompounds$Group.1
avgScentCompounds$Group.1 <- NULL
avgScentCompounds <- as.matrix(avgScentCompounds)
```

# Test for Phylogenetic Signal

## Test for Phylogenetic Signal Individualy
Bloombergs K for each Individual 
```{r BloombergsK_Individually, results="hide"}
# Picante
multiPhylosignal(avgScentCompounds, tree)
```

## Multivariate Bloombergs K
Two implementation of multivarite Bloombergs K:

### Phylocurve Library 
Significance is assessd by simulating a brownian motion on a star phylogeny. 

```{r Phylocurve_Multivarite_BloombergsK}
model <- evo.model(trimedTree, avgScentCompounds)  
K.mult(model, nsim = 1000, plot = TRUE)
```
Figure Interpretation:
Black desnity plot is null distribution of K values from 1000 simulutions of Brownian motion under a star phylogeny. Blue is a distribution of K values from 1000 simulation on the true phylogeny. Black dotted line is observe K value from Bloombergs K analys. This value falls well within the null distribution of simulation, indicating that there is no phylogenetic signal. I am not sure what the red line is. 

### Geomorph Implimentation 
Significance is assessed is found by permutating the shape data among the tips of the phylogeny. 

``` {r Geomorph_Multivarite_BloombergsK}
physignal(avgScentCompounds,trimedTree)
```